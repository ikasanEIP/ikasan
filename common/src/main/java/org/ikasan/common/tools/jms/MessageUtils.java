/*
 * $Id$
 * $URL$
 * 
 * ====================================================================
 * Ikasan Enterprise Integration Platform
 * Copyright (c) 2003-2008 Mizuho International plc. and individual contributors as indicated
 * by the @authors tag. See the copyright.txt in the distribution for a
 * full listing of individual contributors.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the 
 * Free Software Foundation Europe e.V. Talstrasse 110, 40217 Dusseldorf, Germany 
 * or see the FSF site: http://www.fsfeurope.org/.
 * ====================================================================
 */
package org.ikasan.common.tools.jms;

import org.apache.commons.cli.BasicParser;
import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.HelpFormatter;
import org.apache.commons.cli.Options;
import org.apache.commons.cli.ParseException;
import org.apache.commons.codec.DecoderException;
import org.apache.log4j.Logger;
import org.ikasan.common.Payload;
import org.ikasan.common.ResourceLoader;
import org.ikasan.common.ServiceLocator;
import org.ikasan.common.component.Encoding;
import org.ikasan.common.util.Codec;
import org.ikasan.common.xml.serializer.PayloadXmlSerializer;

/**
 * Utility which can be run on the command line to decode encoded <code>org.ikasan.common.Payload</code> 
 * as read through database browsers.
 * 
 * TODO: This is a quick implementation - could be made more elaborate.
 * 
 * @author Ikasan Development Team
 *
 */
public class MessageUtils
{
    /** Logger for this class */
    private static Logger logger = Logger.getLogger(MessageUtils.class);
    
    /** The default expected message encoding */
    private String inputEncoding = null;
    
    /** The default output format for the decoded message */
    private String outputFormat = null;
    
    /** The encoded String */
    private String encodedString = null;
    
    /**
     * @param inputEncoding
     * @param outputFormat
     * @param encodedString
     */
    public MessageUtils(String inputEncoding, String outputFormat, String encodedString)
    {
        this.inputEncoding = inputEncoding;
        this.outputFormat = outputFormat;
        this.encodedString = encodedString;
    }
    /**
     * This method parses the arguments passed in from the command line and
     * creates appropriate hooks for accessing the values.
     * 
     * @param args
     * @return MessageUtils instance
     */
    private static MessageUtils processArgs(String args[])
    {
        Options opt = new Options();
        opt.addOption("h", false, "Help");
        opt.addOption("e", true, "The encoding used for this message. Can be 'hex' (default) or 'base64'");
        opt.addOption("f", true, "The output format. This can be 'plain'(default) text or 'xml'.");
        opt.addOption("s", true, "The encoded message string");
        BasicParser parser = new BasicParser();
        
        String outputFormat = "plain";
        String inputEncoding = "hex";
        String encodedString = "";
        
        CommandLine cl = null;
        try
        {
            cl = parser.parse(opt, args);

            if ((cl.getArgs().length < 1) && (cl.getArgs().length == 1 && !cl.hasOption('s')))
            {
                echoHelpAndExit(opt);
            }
            
            if (cl.hasOption('h'))
            {
                echoHelpAndExit(opt);
            }
            
            if (cl.hasOption('f'))
            {
                String ov = cl.getOptionValue('f');
                if (ov.equalsIgnoreCase("XML"))
                    outputFormat = "xml";
                else if (ov.equalsIgnoreCase("plain"))
                    outputFormat = "plain";
                else
                    echoHelpAndExit(opt);
            }
            
            if (cl.hasOption('e'))
            {
                String ov = cl.getOptionValue('e');
                if (ov.equalsIgnoreCase("base64"))
                    inputEncoding= "base64";
                else if (ov.equalsIgnoreCase("hex"))
                    inputEncoding= "hex";
                else
                    echoHelpAndExit(opt);
            }
            
            encodedString = cl.getOptionValue('s');
        }
        catch (ParseException e)
        {
            logger.fatal("Failed to parse the command line args: [" + args + "]", e);
            System.exit(-1);
        }
        
        return new MessageUtils(inputEncoding, outputFormat, encodedString);
    }
   /**
    * Dumps the help output and exits the application.
    * @param opt
    */
   private static void echoHelpAndExit(Options opt)
   {
       HelpFormatter f = new HelpFormatter();
       f.printHelp("MessageUtils", opt); //$NON-NLS-1$
       System.exit(0);
   }
   
   /**
    * Decode the message
    */
   private void decode()
   {
       try
       {
           byte[] decodedContent = Codec.decode(encodedString.getBytes(), inputEncoding);
           // create and populate the payload instance
           // TODO Global service locator
           ServiceLocator serviceLocator = ResourceLoader.getInstance();
           Payload payload = 
               serviceLocator.getPayloadFactory().newPayload("decodedString", "", "", decodedContent);
           payload.setContent(decodedContent);
           payload.setEncoding(Encoding.NOENC.toString());
           if (outputFormat.equals("xml")){
               PayloadXmlSerializer payloadXmlSerializer = new PayloadXmlSerializer(payload.getClass());
               System.out.println(payloadXmlSerializer.toXml(payload));
           }
           else{
               System.out.println(payload.toString());
           }
       }
       catch(DecoderException e)
       {
           System.out.println("Failed to decode the encoded string");
       }
   }
   
    /**
     * @param args
     */
    public static void main(String[] args)
    {
        MessageUtils mu = processArgs(args);
        mu.decode();
        
//        String b64Msg = "0000001F00137061796C6F61645F305F73726353797374656D0100126A766272696467652D73746174696353726300127061796C6F61645F305F636865636B73756D010020303635663734346139356232353037383738666133383736646630633133623900137061796C6F61645F305F74696D657374616D7006000001179D0145E9000E7061796C6F61645F305F73697A6506000000000000693C001C7061796C6F61645F305F666F726D617474656454696D657374616D7001001132303038303132313135333934313932390018656E76656C6F70655F74696D657374616D70466F726D6174010011797979794D4D646448486D6D73735353530011656E76656C6F70655F74696D657A6F6E650100035554430014656E76656C6F70655F636865636B73756D416C670100034D443500127061796C6F61645F305F74696D657A6F6E650100035554430010656E76656C6F70655F6368617273657401000A49534F2D383835392D31000D656E76656C6F70655F6E616D65010008636D66417373657400117061796C6F61645F305F6368617273657401000A49534F2D383835392D3100197061796C6F61645F305F74696D657374616D70466F726D6174010011797979794D4D646448486D6D7373535353001D7061796C6F61645F305F736368656D61496E7374616E63654E53555249010029687474703A2F2F7777772E77332E6F72672F323030312F584D4C536368656D612D696E7374616E6365000C7061796C6F61645F305F696401002437336530373661302D663733362D343531362D383137642D6262636430623431356136630012656E76656C6F70655F74696D657374616D7006000001179D01455B00157061796C6F61645F305F636865636B73756D416C670100034D4435001B656E76656C6F70655F666F726D617474656454696D657374616D700100113230303830313231313533393431373837000B656E76656C6F70655F696401002461653232643834312D636432622D343661332D386238632D393839323364346463343234000E7061796C6F61645F305F6E616D65010008636D66417373657400117061796C6F61645F305F636F6E74656E740A0000693C3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D38223F3E0A3C21444F435459504520636D6641737365742053595354454D2022687474703A2F2F6D68692D7765623031702F7669747269612F636D692F6C6F6E646F6E2F636F6E6669672F6474642F636D662F636D6641737365742E647464223E0A3C636D6641737365743E0A3C636D664864723E0A3C636D664461746554696D6520545950453D226461746554696D65222054494D455A4F4E453D22474D54223E32303038303132313135333932393334383C2F636D664461746554696D653E0A3C636D665372634576656E744E616D653E7264775F41737365744F75743C2F636D665372634576656E744E616D653E0A3C636D66536F7572636553797374656D3E7264773C2F636D66536F7572636553797374656D3E0A3C636D6654617267657453797374656D2F3E0A3C636D6654687265616449643E303C2F636D6654687265616449643E0A3C636D6649643E313034383C2F636D6649643E0A3C636D664576656E7449643E313233383832373C2F636D664576656E7449643E0A3C636D6650726F636573734B65792F3E0A3C636D6653756250726F636573734B65792F3E0A3C636D66416374696F6E2F3E0A3C636D664170706C6E4B6579732F3E0A3C636D66436F6D6D656E742F3E0A3C636D665072696F726974793E686967683C2F636D665072696F726974793E0A3C2F636D664864723E0A3C636D66426F64793E0A3C76616C69646174656441737365743E0A3C7374617475733E416D656E643C2F7374617475733E0A3C73797374656D54696D657374616D702054494D455A4F4E453D22474D54223E32312D4A616E2D323030382031353A33393A32303A3435363C2F73797374656D54696D657374616D703E0A3C7573657249643E6164616D6A6F3C2F7573657249643E0A3C61737365744E616D6520545950453D22446562742220535542545950453D22426F6E6422204F574E4552534849505F545950453D22426561726572222044454C49564552595F464F524D3D22426F6F6B20456E747279222050524943494E475F4D554C5449504C4945523D2231222049535355455F444154453D223230303630353331303030303030303030222049535355455F554E49543D22313030302E303030222049535355455F50524943453D223130302E303030303030303030303030222049535355455F5354415455533D22497373756564222049535355455F4D4554484F443D22556E6B6E6F776E222049535355455F43555252454E43593D22455552222049535355455F4E4F4D494E414C3D2235363030303030302E303030222044454E4F4D494E4154494F4E5F43555252454E43593D22455552222043555252454E545F4E4F4D494E414C3D2235363030303030302E3030303030302220524F554E445F4C4F545F53495A453D22312E303030223E462D4520474F4C4420532E522E4C2F5641522033302F30372F32353C2F61737365744E616D653E0A3C6964656E746966696572436F64653E0A3C6B6E6F776E4964656E7469666965723E0A3C7264774964204143544956455F5354415455533D22416374697665222046414D494C595F4348414E4745445F444154455F54494D453D22323030383031323131353339313930303022204C4153545F4348414E4745445F444154455F54494D453D223230303830313231313533393139333533223E33303238313C2F72647749643E0A3C6973696E4964204143544956455F5354415455533D22416374697665223E4954303030343036383632303C2F6973696E49643E0A3C626241737365744964204143544956455F5354415455533D22416374697665223E42434330514B4D33373C2F6262417373657449643E0A3C7469636B65724964204143544956455F5354415455533D22416374697665223E46474F4C443C2F7469636B657249643E0A3C6262556E69717565204143544956455F5354415455533D22416374697665223E4D4721213030514B4D333C2F6262556E697175653E0A3C2F6B6E6F776E4964656E7469666965723E0A3C67656E657269634964656E74696669657220545950453D2253657269657322204143544956455F5354415455533D22416374697665223E313C2F67656E657269634964656E7469666965723E0A3C67656E657269634964656E74696669657220545950453D2253656352656622204143544956455F5354415455533D22416374697665223E46474F4C443032353C2F67656E657269634964656E7469666965723E0A3C67656E657269634964656E74696669657220545950453D224D6F6F6479732044656274204E756D22204143544956455F5354415455533D22416374697665223E303830393434393137353C2F67656E657269634964656E7469666965723E0A3C2F6964656E746966696572436F64653E0A3C67656F556E69744964436F64652047454F5F554E49545F52454C4154494F4E534849503D22496E636F72706F726174696F6E222047454F5F554E49545F545950453D22436F756E74727922204944454E5449464945525F545950453D2249534F32222053544152545F444154453D223230303830313231303030303030303030223E49543C2F67656F556E69744964436F64653E0A3C67656F556E69744964436F64652047454F5F554E49545F52454C4154494F4E534849503D22496E636F72706F726174696F6E222047454F5F554E49545F545950453D22436F756E74727922204944454E5449464945525F545950453D2249534F33222053544152545F444154453D223230303830313231303030303030303030223E4954413C2F67656F556E69744964436F64653E0A3C67656F556E69744964436F64652047454F5F554E49545F52454C4154494F4E534849503D225265736964656E6365222047454F5F554E49545F545950453D22436F756E74727922204944454E5449464945525F545950453D2249534F32222053544152545F444154453D223230303830313231303030303030303030223E49543C2F67656F556E69744964436F64653E0A3C67656F556E69744964436F64652047454F5F554E49545F52454C4154494F4E534849503D225265736964656E6365222047454F5F554E49545F545950453D22436F756E74727922204944454E5449464945525F545950453D2249534F33222053544152545F444154453D223230303830313231303030303030303030223E4954413C2F67656F556E69744964436F64653E0A3C67656F556E69744964436F64652047454F5F554E49545F52454C4154494F4E534849503D225269736B222047454F5F554E49545F545950453D22436F756E74727922204944454E5449464945525F545950453D2249534F32222053544152545F444154453D223230303630353233303030303030303030223E49543C2F67656F556E69744964436F64653E0A3C67656F556E69744964436F64652047454F5F554E49545F52454C4154494F4E534849503D225269736B222047454F5F554E49545F545950453D22436F756E74727922204944454E5449464945525F545950453D2249534F33222053544152545F444154453D223230303630353233303030303030303030223E4954413C2F67656F556E69744964436F64653E0A3C726174696E672047524F55505F4E414D453D224D6F6F64797320417373657420526174696E67732220534348454D453D224D6F6F647973204C5420436F6C6C61746572616C69736564204E6F746520526174696E672220444952454354494F4E3D2244454622204F4E5F57415443484C4953543D2230222053544152545F444154453D223230303630363031303030303030303030222056454E444F525F4944454E5449464945525F545950453D224D6F6F6479732044656274204E756D222056454E444F525F4944454E5449464945525F56414C55453D2230383039343439313735223E41313C2F726174696E673E0A3C726174696E672047524F55505F4E414D453D224465726976656420526174696E67732220534348454D453D22426173656C20494920417373657420526174696E6722204F4E5F57415443484C4953543D2230222053544152545F444154453D223230303730383235303030303030303030222056454E444F525F4944454E5449464945525F56414C55453D224D6F6F647973223E41313C2F726174696E673E0A3C726174696E672047524F55505F4E414D453D224465726976656420526174696E67732220534348454D453D22426173656C20494920417373657420526174696E67205374616E6461726422204F4E5F57415443484C4953543D2230222053544152545F444154453D223230303730383235303030303030303030223E412B3C2F726174696E673E0A3C726174696E672047524F55505F4E414D453D224465726976656420526174696E67732220534348454D453D2244657269766564204D6F6F64797322204F4E5F57415443484C4953543D2230222053544152545F444154453D223230303630363032303030303030303030223E41313C2F726174696E673E0A3C726174696E672047524F55505F4E414D453D224465726976656420526174696E67732220534348454D453D224465726976656420506F6C69637922204F4E5F57415443484C4953543D2230222053544152545F444154453D223230303630363032303030303030303030223E412B3C2F726174696E673E0A3C67726F757020504152454E545F47524F55505F4E414D453D22427573696E65737347726F7570222053544152545F444154453D223230303630353233303030303030303030223E437573746F64794173736574733C2F67726F75703E0A3C67726F757020504152454E545F47524F55505F4E414D453D225175616C696679696E674465627447726F7570222053544152545F444154453D223230303630363032303030303030303030223E5175616C696679696E67446562743C2F67726F75703E0A3C72656C6174656450617274793E0A3C6B6E6F776E52656C6174656450617274793E0A3C70617274794973737565722050415254595F545950453D225244575F4944222050415254595F4E414D453D22462D4520474F4C4420532E522E4C222053544152545F444154453D223230303730383131303030303030303030223E31303131353C2F70617274794973737565723E0A3C2F6B6E6F776E52656C6174656450617274793E0A3C67656E6572696352656C6174656450617274792050415254595F524F4C453D225072696D61727945786368616E6765222050415254595F545950453D225244575F4944222050415254595F4E414D453D2249534D41202D20494E544C2053454355524954494553204D41524B4554204153534F43222053544152545F444154453D223230303630353233303030303030303030223E343734363C2F67656E6572696352656C6174656450617274793E0A3C2F72656C6174656450617274793E0A3C696E636F6D6544657461696C3E0A3C636F75706F6E44657461696C20434F55504F4E5F545950453D22466C6F6174696E672220434F55504F4E5F4D4554484F443D22436F75706F6E222046495253545F4143435255414C5F53544152545F444154453D223230303630353331303030303030303030222046495253545F434F55504F4E5F5041595F444154453D223230303630373331303030303030303030222049525245475F46495253545F434F55504F4E3D2274727565222049525245475F4C4153545F434F55504F4E3D2266616C736522204649585F414E4E4F554E43455F4F46465345543D222D3222204649585F414E4E4F554E43455F4F46465345545F4441593D22436F75706F6E53746172744461746522204255535F444154455F434F4E56454E54494F4E3D224D6F64696669656420466F6C6C6F77696E6720556E61646A75737465642220434F55504F4E5F43414C43554C4154494F4E5F545950453D2231223E0A3C636F75706F6E5465726D20434F55504F4E5F5445524D5F53544152545F444154453D2232303036303533313030303030303030302220434F55504F4E5F5445524D5F454E445F444154453D22323032353037323930303030303030303022204143435255414C5F545950453D22466C6F6174696E672220444159535F5045525F4D4F4E54485F42415349533D224143542220444159535F5045525F594541525F42415349533D2233363022204143435255414C5F444154455F465245515F4E554D3D223322204143435255414C5F444154455F465245515F554E49543D224D6F6E7468732220434F55504F4E5F43555252454E43593D224555522220464958494E475F444154455F4F46465345543D22302220524556455253455F464C4F415445525F494E443D2266616C7365223E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303036303532363030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303036303733303030303030303030302220434F55504F4E5F444159533D2236312E303030223E32303036303533313030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303036303732393030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303036313032393030303030303030302220434F55504F4E5F444159533D2239312E3030302220434F55504F4E5F524154453D22332E343236303030303030303030223E32303036303733313030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303036313032383030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303037303132393030303030303030302220434F55504F4E5F444159533D2239322E3030302220434F55504F4E5F524154453D22332E383238303030303030303030223E32303036313033303030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303037303132383030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303037303432393030303030303030302220434F55504F4E5F444159533D2239302E3030302220434F55504F4E5F524154453D22342E303532303030303030303030223E32303037303133303030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303037303432383030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303037303732393030303030303030302220434F55504F4E5F444159533D2239312E3030302220434F55504F4E5F524154453D22342E323835303030303030303030223E32303037303433303030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303037303732383030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303037313032393030303030303030302220434F55504F4E5F444159533D2239322E3030302220434F55504F4E5F524154453D22342E353235303030303030303030223E32303037303733303030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303037313032383030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303038303132393030303030303030302220434F55504F4E5F444159533D2239322E3030302220434F55504F4E5F524154453D22342E383835303030303030303030223E32303037313033303030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303038303132383030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303038303432393030303030303030302220434F55504F4E5F444159533D2239312E303030223E32303038303133303030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303038303432383030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303038303732393030303030303030302220434F55504F4E5F444159533D2239312E303030223E32303038303433303030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303038303732383030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303038303733303030303030303030302220434F55504F4E5F444159533D22312E303030223E32303038303733303030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303038303732393030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303038313033303030303030303030302220434F55504F4E5F444159533D2239322E303030223E32303038303733313030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303038313032393030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303039303133303030303030303030302220434F55504F4E5F444159533D2239322E303030223E32303038313033313030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303039303132393030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303039303432393030303030303030302220434F55504F4E5F444159533D2238392E303030223E32303039303133313030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303039303432383030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303039303732393030303030303030302220434F55504F4E5F444159533D2239312E303030223E32303039303433303030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303039303732383030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303039303733303030303030303030302220434F55504F4E5F444159533D22312E303030223E32303039303733303030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303039303732393030303030303030302220434F55504F4E5F5343484544554C455F454E445F444154453D2232303039313033303030303030303030302220434F55504F4E5F444159533D2239322E303030223E32303039303733313030303030303030303C2F636F75706F6E5363686564756C653E0A3C636F75706F6E5363686564756C6520414E4E4F554E43454D454E545F444154453D2232303039313032393030303030303030302220434F55504F4E5F5343484544554C455F454E44";
//        try
//        {
//            byte[] decodedContent = Codec.decode(b64Msg.getBytes(), Encoding.HEX.toString());
//            // create and populate the payload instance
//            Payload payload = ResourceLoader.getInstance().newPayload("decodedMsg",
//                "", "", decodedContent);
//            payload.setContent(decodedContent);
//            payload.setEncoding(Encoding.NOENC.toString());
//            System.out.println(payload.toXML());
//        }
//        catch(DecoderException e)
//        {
//            System.out.println("Failed to decode the encoded string");
//        }

    }
}
