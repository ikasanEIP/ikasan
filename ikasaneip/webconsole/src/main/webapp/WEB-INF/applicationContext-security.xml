<?xml version="1.0" encoding="UTF-8"?>
<!-- 
# //
# //
# // $Id$
# // $URL$
# // 
# // ====================================================================
# // Ikasan Enterprise Integration Platform
# // 
# // Distributed under the Modified BSD License.
# // Copyright notice: The copyright for this software and a full listing 
# // of individual contributors are as shown in the packaged copyright.txt 
# // file. 
# // 
# // All rights reserved.
# //
# // Redistribution and use in source and binary forms, with or without 
# // modification, are permitted provided that the following conditions are met:
# //
# //  - Redistributions of source code must retain the above copyright notice, 
# //    this list of conditions and the following disclaimer.
# //
# //  - Redistributions in binary form must reproduce the above copyright notice, 
# //    this list of conditions and the following disclaimer in the documentation 
# //    and/or other materials provided with the distribution.
# //
# //  - Neither the name of the ORGANIZATION nor the names of its contributors may
# //    be used to endorse or promote products derived from this software without 
# //    specific prior written permission.
# //
# // THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" 
# // AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
# // IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE 
# // DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE 
# // FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
# // DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR 
# // SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER 
# // CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# // OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE 
# // USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
# // ====================================================================
# //
# // Author:  Ikasan Development Team
# // 
-->
<beans:beans xmlns="http://www.springframework.org/schema/security"
	xmlns:beans="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
              http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.4.xsd">
	<http access-denied-page="/accessDenied.jsp" auto-config='true'>
		<intercept-url pattern="/login.jsp*" filters="none" />
		<intercept-url pattern='/css/*' filters='none' />
		<intercept-url pattern='/images/*' filters='none' />
		<intercept-url pattern="/admin/*" access="ROLE_ADMIN" />
		<intercept-url pattern="/**" access="ROLE_USER" />
		<form-login login-page='/login.jsp'
			authentication-failure-url='/login.jsp?login_error=1' />

	</http>


	<authentication-provider user-service-ref="userDetailsService">
		<password-encoder ref="sha1PasswordEncoder" />
	</authentication-provider>
    
    <beans:bean id="sha1PasswordEncoder" class="org.springframework.security.providers.encoding.ShaPasswordEncoder"/>

	<beans:bean id="userDetailsService"
		class="org.ikasan.framework.security.service.UserServiceImpl">
		<beans:constructor-arg ref="userDao"/>
		<beans:constructor-arg ref="authorityDao"/>
		<beans:constructor-arg ref="sha1PasswordEncoder"/>
	</beans:bean>
	
	<beans:bean id="userDao" class="org.ikasan.framework.security.dao.HibernateUserDao">
        <beans:property name="sessionFactory" ref="securitySessionFactory"/>
    </beans:bean>
	
    <beans:bean id="authorityDao" class="org.ikasan.framework.security.dao.HibernateAuthorityDao">
        <beans:property name="sessionFactory" ref="securitySessionFactory"/>
    </beans:bean>	


     <beans:bean id="securitySessionFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
        <beans:property name="dataSource" ref="ikasanAdminLocalTxDataSource" />
        <beans:property name="mappingResources">
            <beans:list>
                <beans:value>org/ikasan/framework/security/model/User.hbm.xml</beans:value>
                <beans:value>org/ikasan/framework/security/model/Authority.hbm.xml</beans:value>
            </beans:list>
        </beans:property>
        <beans:property name="hibernateProperties" ref="platformHibernateProperties"/>
    </beans:bean>

	<!-- Automatically receives AuthenticationEvent messages -->
	<beans:bean id="loggerListener"
		class="org.springframework.security.event.authentication.LoggerListener" />

	<global-method-security access-decision-manager-ref="accessDecisionManager">

		
		<!--
			AspectJ pointcut expression that locates our "post" method and
			applies security that way
		-->

		<protect-pointcut
			expression="execution(* org.ikasan.framework.module.service.ModuleService.startInitiator(..))"
			access="MODULE_ADMIN" />
		<protect-pointcut
			expression="execution(* org.ikasan.framework.module.service.ModuleService.stopInitiator(..))"
			access="MODULE_ADMIN" />
        <protect-pointcut
            expression="execution(* org.ikasan.framework.security.service.UserService.changeUsersPassword(..))"
            access="ROLE_ADMIN" />
            
        <protect-pointcut
            expression="execution(* org.ikasan.framework.security.service.UserService.grantAuthority(..))"
            access="ROLE_ADMIN" />
        
        <protect-pointcut
            expression="execution(* org.ikasan.framework.security.service.UserService.revokeAuthority(..))"
            access="ROLE_ADMIN" />

	    <!-- Gaining access to a Module requires security check -->
		<protect-pointcut 
            expression="execution(* org.ikasan.framework.module.service.ModuleService.getModule(..))"
            access="ROLE_USER,AFTER_MODULE_READ" /> 
        <protect-pointcut
            expression="execution(*
            org.ikasan.framework.module.service.ModuleService.getModules())"
            access="ROLE_USER,AFTER_MODULE_COLLECTION_READ" />
		
	</global-method-security>

	<beans:bean id="accessDecisionManager" class="org.springframework.security.vote.UnanimousBased">
    	<beans:property name="allowIfAllAbstainDecisions" value="true"/>
	    <beans:property name="decisionVoters">
	       <beans:list>
	           <beans:bean id="roleVoter" class="org.springframework.security.vote.RoleVoter"/>
	           <beans:bean id="moduleAdminVoter" class="org.ikasan.framework.security.ModuleAdminVoter"/>  
	       </beans:list>
	   </beans:property>
	</beans:bean>
	
    <beans:bean id="moduleCollectionFilteringAfterInvocationProvider"
        class="org.ikasan.framework.security.AfterInvocationModuleCollectionFilteringProvider">
        <custom-after-invocation-provider />
    </beans:bean>
    
    <beans:bean id="moduleAfterInvocationProvider"
        class="org.ikasan.framework.security.ModuleAfterInvocationProvider">
        <custom-after-invocation-provider />
    </beans:bean>



</beans:beans>
