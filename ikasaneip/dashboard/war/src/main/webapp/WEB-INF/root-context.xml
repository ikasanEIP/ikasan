<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:security="http://www.springframework.org/schema/security"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd
		http://www.springframework.org/schema/security 
        http://www.springframework.org/schema/security/spring-security-2.0.4.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.1.xsd">

    <context:annotation-config/>
    <context:component-scan base-package="org.ikasan.mapping.configuration.ui"/>

    <bean id="messageSource" class="org.springframework.context.support.ReloadableResourceBundleMessageSource">
        <property name="basename" value="classpath:/locales/messages"/>
        <property name="fallbackToSystemLocale" value="false" />
    </bean>

    <bean class="ru.xpoft.vaadin.VaadinMessageSource" />

    <bean id="ikasanUI" class="org.ikasan.dashboard.ui.IkasanUI" scope="prototype">
        <constructor-arg ref="navigatorMap"/>
        <constructor-arg ref="mappingViewComponentContainer"/>
        <constructor-arg ref="localTxUserService"/>
        <constructor-arg ref="localTxAuthenticationService"/>
        <constructor-arg ref="adminUserVisibilityGroup"/>
        <constructor-arg ref="editableGroup"/>
        <constructor-arg ref="newMappingConfigurationFunctionalGroup"/>
        <constructor-arg ref="existingMappingConfigurationFunctionalGroup"/>
        <constructor-arg ref="eventBus"/>
        <constructor-arg ref="imagePanelLayout"/>
        <constructor-arg ref="navigationPanel"/>
    </bean>

	<bean id="eventBus" class="com.google.common.eventbus.EventBus" scope="session"/>

	<util:map id="navigatorMap" value-type="java.util.List" map-class="java.util.HashMap" scope="session">
	  <entry key="topLevel" value-ref="topLevelNavigator" />
      <entry key="mapping" value-ref="mappingNavigator" />
      <entry key="dashboard" value-ref="dashboardNavigator" />
      <entry key="error" value-ref="errorNavigator" />
      <entry key="user" value-ref="userNavigator" />
      <entry key="replay" value-ref="replayNavigator" />
      <entry key="profile" value-ref="profileNavigator" />
      <entry key="hospital" value-ref="hospitalNavigator" />
      <!--  entry key="topology" value-ref="topologyNavigator" / -->
      <entry key="persistanceSetup" value-ref="persistanceSetupNavigator" />
      <entry key="principalManagement" value-ref="principalNavigator" />
      <entry key="roleManagement" value-ref="roleNavigator" />
      <entry key="policyManagement" value-ref="policyManagementNavigator" />
    </util:map>

	<bean id="topLevelNavigator" class="org.ikasan.dashboard.ui.framework.navigation.IkasanUINavigator" scope="session">
		<constructor-arg value="topLevel"/>
        <constructor-arg>
            <list>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="landingView"/>
                   <constructor-arg ref="emptyPanel"/>
                </bean>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="emptyPanel"/>
                   <constructor-arg ref="emptyPanel"/>
                </bean>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="dashboardView"/>
                   <constructor-arg ref="dashboardPanel"/>
                </bean>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="mappingView"/>
                   <constructor-arg ref="mappingView"/>
                </bean>
                 <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="errorView"/>
                   <constructor-arg ref="errorPanel"/>
                </bean>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="userView"/>
                   <constructor-arg ref="userPanel"/>
                </bean>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="replayView"/>
                   <constructor-arg ref="replayPanel"/>
                </bean>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="profileView"/>
                   <constructor-arg ref="profilePanel"/>
                </bean>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="hospitalView"/>
                   <constructor-arg ref="hospitalPanel"/>
                </bean>
                <!--  bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="topologyView"/>
                   <constructor-arg ref="estateViewPanel"/>
                </bean -->
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="persistanceSetupView"/>
                   <constructor-arg ref="persistanceSetupPanel"/>
                </bean>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="authenticationMethodView"/>
                   <constructor-arg ref="authenticationMethodPanel"/>
                </bean>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="principalManagementView"/>
                   <constructor-arg ref="principalManagementPanel"/>
                </bean>
                <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="roleManagementView"/>
                   <constructor-arg ref="roleManagementPanel"/>
                </bean>
                 <bean class="org.ikasan.dashboard.ui.framework.display.IkasanUIView" >
                   <constructor-arg value="policyManagementView"/>
                   <constructor-arg ref="policyManagementPanel"/>
                </bean>
            </list>
        </constructor-arg>
        <constructor-arg ref="dashboardViewComponentContainer"/>
    </bean>
	
	<!-- Very Important: We need to use this proxy bean to avoid a circular dependency!! -->
    <bean id="navigationPanelProxy" class="org.springframework.aop.framework.ProxyFactoryBean">
      <property name="targetSource">
        <bean class="org.springframework.aop.target.LazyInitTargetSource">
          <property name="targetBeanName"><idref local="navigationPanel"/></property>
        </bean>
      </property>
    </bean>
    
    <bean id="navigationPanel" class="org.ikasan.dashboard.ui.framework.panel.NavigationPanel" scope="session">
		<constructor-arg ref="localTxAuthenticationService"/>
		<constructor-arg ref="adminUserVisibilityGroup"/>
        <constructor-arg ref="editableGroup"/>
		<constructor-arg ref="newMappingConfigurationFunctionalGroup"/>
        <constructor-arg ref="existingMappingConfigurationFunctionalGroup"/>
        <constructor-arg ref="imagePanelLayout"/>
		<constructor-arg ref="navigatorMap"/>
	</bean>

    <bean id="policyLinkSearchResultTableItemClickListener" class="org.ikasan.dashboard.ui.mappingconfiguration.listener.PolicyLinkMappingSearchResultTableItemClickListener" lazy-init="true" scope="session">
        <constructor-arg ref="policyAssociationMappingSearchWindow"/>
    </bean>
	
	<bean id="imagePanelLayout" class="com.vaadin.ui.VerticalLayout" scope="session">
	</bean>
    
    <bean id="emptyPanel" class="com.vaadin.navigator.Navigator.EmptyView" scope="session">
    </bean>

	<bean id="authenticationMethodPanel" class="org.ikasan.dashboard.ui.framework.panel.AuthenticationMethodPanel" scope="session">
		 <constructor-arg ref="localTxSecurityService"/>
		 <constructor-arg ref="localTxAuthenticationProviderFactory"/>
		 <constructor-arg ref="localTxLdapService"/>
    </bean>

	 <bean id="ikasan.xads"
                class="org.springframework.jndi.JndiObjectFactoryBean">
     	<property name="jndiName" value="java:/datasource/ikasan/xads" />
     </bean>

    <bean id="ikasan.ds"
            class="org.springframework.jndi.JndiObjectFactoryBean">
    	<property name="jndiName" value="java:/datasource/ikasan/ds" />
    </bean>

</beans>